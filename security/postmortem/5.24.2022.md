# Postmortem for medium severity bug identified on May 24, 2022.

# Summary

A bug triggered by two successive reconfigurations in a rolled-over funding cycle would result in an unexpected state for the project's funding cycle. No fund were at risk or lost. The issue is now mitigated.

## Overview 

This bug was stumbled upon by 0xSTVG and confirmed by Jango in a Discord message here: https://discord.com/channels/775859454780244028/876252266594721873/978704562540122172 (Screenshots attached at the bottom).

The Pull Request that fixes the bug can be found here: https://github.com/jbx-protocol/juice-contracts-v2/pull/265

## Severity 

No funds were immediately at risk. The bug made it possible for projects to end up in an unexpected funding cycle state, which would interrupt regular treasury operating behavior and allow projects to bypass funding cycle duration constraints.

## Behavior

To recreate the bug, follow these steps:

* Configure a funding cycle (FC#N) with a duration.
* Let the FC#N rollover to another funding cycle (FC#N+1). this step is necessary.
* Send a transaction to reconfigure the next funding cycle (FC#N+2) before FC#N+1 expires.
* Send another transaction to reconfigure the next funding cycle (FC#N+2) before FC#N+1 expires.

The expected behavior is that FC#N+1 is still the current funding cycle (`JBFundingCycleStore.getCurrentOf(...)`), and that the queued funding cycle is the latest configuration of FC#N+2 (`JBFundingCycleStore.getQueuedOf(...)`).

The unexpected behavior that takes affect is that the first reconfiguration of FC#N+2 immediately becomes the current funding cycle (`JBFundingCycleStore.getCurrentOf(...)`) once the second reconfiguration transaction succeeds.

## Specifics

The bug was caused by the lack of an `OR` condition in an `if` statement in the `_configureIntrinsicPropertiesFor` of the `JBFundingCycleStore`. See this pull request for the code specifics and accompanying added tests https://github.com/jbx-protocol/juice-contracts-v2/pull/265.

The fix was redeployed on May 25, 2022 alongside changes merged form the following PRs:

https://github.com/jbx-protocol/juice-contracts-v2/pull/257
https://github.com/jbx-protocol/juice-contracts-v2/pull/262
https://github.com/jbx-protocol/juice-contracts-v2/pull/264
https://github.com/jbx-protocol/juice-contracts-v2/pull/266
 
The updated artificats can be found in this PR:

https://github.com/jbx-protocol/juice-contracts-v2/pull/267

A new `JBFundingCycleStore` was deployed on May 25, 2022. All contracts that dependend on the old `JBFundingCycleStore` or upstream dependencies were also redeployed, including `JBDirectory`, `JBController`, `JBETHPaymentTerminal`, `JBSingleTokenPaymentTerminalStore`, `JBSplitsStore`, and `JBTokenStore`.

The addresses of old contracts are as follows:

`JBDirectory`: "0xd73D3Df051f6C7fa9e5bDC2fd71ecD3bc835C808"\
`JBController`: "0x43780E780DF2bD1e4d955d3d4b577a490841241A"\
`JBETHPaymentTerminal`: "0x2109e1CaF001980C318Ad7efdE8Fc204a844273b"\
`JBSingleTokenPaymentTerminalStore`: "0x0fF58316f44D53ec1bA2b9D07f163Bd0d9270794"\
`JBSplitsStore`: "0x32bb71C6DbD6A1b3A37394565872D0eB7fF3846D"\
`JBTokenStore`: "0x9c54a10a35bF8cC8bF4AE52198c782c5681c9470"\

The addresses of the new contracts are as follow:

`JBDirectory`: "0xf2e11aAeE51D34921f9397731f8fa16E35ed4088"\
`JBController`: "0x833d3996D3EF1b34320F56ac97c899065A3Cb2EF"\
`JBETHPaymentTerminal`: "0x5a92f8aa0d3e656aE209E99C5B77B1ca464Ae1a9"\
`JBSingleTokenPaymentTerminalStore`: "0x31e8B24E93e807E4a82960f4181ee37c7b04CcCd"\
`JBSplitsStore`: "0x2880B17aA444666a296Ab2866968e1bbE94Dd7FC"\
`JBTokenStore`: "0xC42f85261aEbd06edd0615005954063B4Fd032aB"\

The old contracts and interfaces were kept, and new ones were added alongside. For contracts that were updated, there are now a `1.sol` and `2.sol` files under a folder identified by the contract's name or interface's name. Similarly, the new deployment artifacts were added alongside the old versions suffixed by `_2.json`.

Given the nascency of the project and that external system depending on this repository's artifacts are known, once there is no longer a need to reference the old contracts in the repository to resolve potential migrations, the `1.sol` files can safely be removed and `_2.json` artifacts can overwrite the plain versions to minimize complexity for future contributors, auditors, and audiences in general. 

## Recourse

Projects do not have to re-mint their ERC721 instance in `JBProjects`, nor do they have to re-issue their ERC-20 tokens. Projects can move their already-issued ERC20's from the old `JBTokenStore` to the new `JBTokenStore` using `JBTokenStore.changeFor(...)` transactions as follows:

* On the old `JBTokenStore`, call `changeFor(...)` with no new token (empty address), and the address of the new `JBTokenStore` as the `_newOwner`.
* On the new `JBTokenStore`, call `changeFor(...)` passing the token's address.

In order to use the updated contracts, projects must re-instantiate their funding cycles, re-distribute tokens to their holders, and move funds out of the current terminal contracts and optionally into their updated payment terminal once all other steps are complete. 

They can re-instantiate their funding cycles as follows:

* On the new `JBController`, call `launchFundingCyclesFor(...)` with the desired funding cycle properties along with the address of the new `JBETHPaymentTerminal` where funds will now be accepted.

Projects can re-distribute tokens to their holders as follows:

* While following the steps above to re-instantiate funding cycles, begin with a funding cycle with no duration that allows token minting.
* Mint a batch of tokens commensurate to sum of tokens that should be distributed to previous holders.
  * If a project's ERC-20 are being ported over using the `changeFor(...)` strategy described above, do not include ERC-20 balances in this calculation. Only include unclaimed balances as the ERC-20 balance will carry over once ported.
* Distribute the tokens to previous holders manually, via an airdrop, or via a 1:1 exchange. 
* Reconfigure the project's funding cycle as desired. 

If a project's treasury funds are greater than its current distribution limit, they can remove funds out of the current payment terminal by reconfiguring their next funding cycle to raise the distribution limit so that it encompasses all of the treasury's funds, routing them to an address that will facilitate their transfer to the updated payment terminal via a call to `addToBalance(...)`.

## References

<img width="1174" alt="image" src="https://user-images.githubusercontent.com/77952627/170569747-727af4f3-436e-4487-bd62-8e79bd96454f.png">
<img width="990" alt="image" src="https://user-images.githubusercontent.com/77952627/170569824-7a0ef986-7f4e-41f8-a001-99dfbfddeb26.png">
<img width="1001" alt="image" src="https://user-images.githubusercontent.com/77952627/170569891-97e0e7b2-55d8-40ac-978d-21e7b339e38f.png">
<img width="991" alt="image" src="https://user-images.githubusercontent.com/77952627/170569974-2c64efd8-3ad3-4360-83a0-2842ca0a4bd7.png">
<img width="989" alt="image" src="https://user-images.githubusercontent.com/77952627/170570036-18283673-be8f-424e-ad05-e9e7806c4c55.png">
<img width="989" alt="image" src="https://user-images.githubusercontent.com/77952627/170570100-d6ec2063-eadd-4beb-b5e1-288f88686642.png">
<img width="990" alt="image" src="https://user-images.githubusercontent.com/77952627/170570161-32663297-0677-43da-937a-e2ebd3aaf9d0.png">
<img width="995" alt="image" src="https://user-images.githubusercontent.com/77952627/170570211-8f53303d-9f6c-4edd-af69-80c4245ed813.png">
<img width="988" alt="image" src="https://user-images.githubusercontent.com/77952627/170570269-8341aa4d-7b7c-494a-a047-041b3a0cc24c.png">
<img width="994" alt="image" src="https://user-images.githubusercontent.com/77952627/170570369-90c3c6c9-c566-4fb0-86df-a8dd280fd838.png">
<img width="999" alt="image" src="https://user-images.githubusercontent.com/77952627/170570466-521becb2-d569-4250-b443-786cc4e55fc2.png">
<img width="988" alt="image" src="https://user-images.githubusercontent.com/77952627/170570531-5480d016-4c8e-4126-a72b-755bdac50b5a.png">
<img width="992" alt="image" src="https://user-images.githubusercontent.com/77952627/170570594-846fb0a1-8aba-4599-84a0-f0a6b5a1cec0.png">
